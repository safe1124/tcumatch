<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase í”„ë¡œí•„ ì €ì¥ ë””ë²„ê·¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .warning { color: orange; font-weight: bold; }
        .info { color: blue; }
        button {
            margin: 10px 5px;
            padding: 10px 15px;
            font-size: 14px;
            cursor: pointer;
        }
        .btn-primary { background: #007bff; color: white; border: none; }
        .btn-success { background: #28a745; color: white; border: none; }
        .btn-danger { background: #dc3545; color: white; border: none; }
        #log {
            background: #f8f9fa;
            padding: 15px;
            border: 1px solid #ddd;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 12px;
        }
        .checklist {
            background: #f0f8ff;
            padding: 15px;
            border-left: 4px solid #007bff;
        }
        .checklist li {
            margin: 10px 0;
        }
        .form-test {
            background: #f9f9f9;
            padding: 15px;
            border: 1px solid #ccc;
        }
        .form-test input, .form-test select, .form-test textarea {
            margin: 5px 0;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Firebase í”„ë¡œí•„ ì €ì¥ ë””ë²„ê·¸ ë„êµ¬</h1>
    
    <div class="section checklist">
        <h3>ğŸ“‹ Firebase Console í™•ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸</h3>
        <ol>
            <li><strong>Authentication ì„¤ì •</strong>:
                <ul>
                    <li>Google ë¡œê·¸ì¸ ì œê³µì—…ì²´ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ê°€?</li>
                    <li>ìŠ¹ì¸ëœ ë„ë©”ì¸ì— <code>localhost</code>, <code>127.0.0.1</code>ì´ ì¶”ê°€ë˜ì–´ ìˆëŠ”ê°€?</li>
                </ul>
            </li>
            <li><strong>Firestore Database ì„¤ì •</strong>:
                <ul>
                    <li>ë°ì´í„°ë² ì´ìŠ¤ê°€ ìƒì„±ë˜ì–´ ìˆëŠ”ê°€?</li>
                    <li>ë³´ì•ˆ ê·œì¹™ì´ ë„ˆë¬´ ì œí•œì ì´ì§€ ì•Šì€ê°€?</li>
                    <li>í…ŒìŠ¤íŠ¸ìš© ì„ì‹œ ê·œì¹™: <code>allow read, write: if request.auth != null;</code></li>
                </ul>
            </li>
            <li><strong>Storage ì„¤ì •</strong>:
                <ul>
                    <li>Storage ë²„í‚·ì´ ìƒì„±ë˜ì–´ ìˆëŠ”ê°€?</li>
                    <li>Storage ë³´ì•ˆ ê·œì¹™ì´ ì„¤ì •ë˜ì–´ ìˆëŠ”ê°€?</li>
                </ul>
            </li>
        </ol>
    </div>
    
    <div class="section">
        <h3>ğŸ” ì¸ì¦ ìƒíƒœ</h3>
        <div id="auth-status">í™•ì¸ ì¤‘...</div>
        <button class="btn-primary" onclick="testLogin()">Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
        <button class="btn-danger" onclick="testLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    
    <div class="section">
        <h3>ğŸ”— Firebase ì—°ê²° í…ŒìŠ¤íŠ¸</h3>
        <div id="connection-status">í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘</div>
        <button class="btn-primary" onclick="testFirebaseConnection()">ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        <button class="btn-primary" onclick="testFirestorePermissions()">Firestore ê¶Œí•œ í…ŒìŠ¤íŠ¸</button>
        <button class="btn-primary" onclick="testStoragePermissions()">Storage ê¶Œí•œ í…ŒìŠ¤íŠ¸</button>
    </div>
    
    <div class="section form-test">
        <h3>ğŸ“ í”„ë¡œí•„ ì €ì¥ í…ŒìŠ¤íŠ¸</h3>
        <form id="debug-profile-form">
            <label>ë‹‰ë„¤ì„:</label>
            <input type="text" id="debug-nickname" value="í…ŒìŠ¤íŠ¸ìœ ì €" required>
            
            <label>ì„±ë³„:</label>
            <select id="debug-gender" required>
                <option value="">ì„ íƒí•˜ì„¸ìš”...</option>
                <option value="male">ë‚¨ì„±</option>
                <option value="female">ì—¬ì„±</option>
                <option value="other">ê¸°íƒ€</option>
            </select>
            
            <label>ìƒë…„ì›”ì¼:</label>
            <input type="date" id="debug-birthdate" value="1995-01-01" required>
            
            <label>ìê¸°ì†Œê°œ:</label>
            <textarea id="debug-bio" rows="3">í…ŒìŠ¤íŠ¸ìš© ìê¸°ì†Œê°œì…ë‹ˆë‹¤.</textarea>
            
            <label>í”„ë¡œí•„ ì‚¬ì§„ (ì„ íƒì‚¬í•­):</label>
            <input type="file" id="debug-profile-pic" accept="image/*">
            
            <br><br>
            <button type="button" class="btn-success" onclick="testProfileSave()">í”„ë¡œí•„ ì €ì¥ í…ŒìŠ¤íŠ¸</button>
        </form>
        <div id="profile-save-status">í…ŒìŠ¤íŠ¸ ëŒ€ê¸° ì¤‘</div>
    </div>
    
    <div class="section">
        <h3>ğŸ“Š ì‹¤ì‹œê°„ ë¡œê·¸</h3>
        <button class="btn-primary" onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        <div id="log"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>

    <script src="js/firebase-config.js"></script>
    
    <script>
        let auth, db, storage, provider;
        let currentUser = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : '';
            logDiv.innerHTML += `[${timestamp}] <span class="${className}">${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            log('ë””ë²„ê·¸ ë„êµ¬ ì‹œì‘');
            initializeFirebase();
        });
        
        function initializeFirebase() {
            try {
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                provider = new firebase.auth.GoogleAuthProvider();
                
                log('Firebase ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
                
                auth.onAuthStateChanged((user) => {
                    const authStatusDiv = document.getElementById('auth-status');
                    if (user) {
                        currentUser = user;
                        authStatusDiv.innerHTML = `<span class="success">âœ… ë¡œê·¸ì¸ë¨: ${user.email}</span>`;
                        log(`ì‚¬ìš©ì ë¡œê·¸ì¸: ${user.email}`, 'success');
                    } else {
                        currentUser = null;
                        authStatusDiv.innerHTML = '<span class="warning">âš ï¸ ë¡œê·¸ì•„ì›ƒë¨</span>';
                        log('ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ', 'warning');
                    }
                });
                
            } catch (error) {
                log(`Firebase ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            log('Google ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ ì‹œì‘');
            try {
                const result = await auth.signInWithPopup(provider);
                log(`ë¡œê·¸ì¸ ì„±ê³µ: ${result.user.email}`, 'success');
            } catch (error) {
                log(`ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        async function testLogout() {
            log('ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸');
            try {
                await auth.signOut();
                log('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ', 'success');
            } catch (error) {
                log(`ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        async function testFirebaseConnection() {
            log('=== Firebase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
            const statusDiv = document.getElementById('connection-status');
            
            try {
                // Firestore ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸
                log('Firestore ì—°ê²° í…ŒìŠ¤íŠ¸...');
                const testCollection = await db.collection('test').limit(1).get();
                log('Firestore ì—°ê²° ì„±ê³µ', 'success');
                
                statusDiv.innerHTML = '<span class="success">âœ… Firebase ì—°ê²° ì„±ê³µ</span>';
                
            } catch (error) {
                log(`Firebase ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
                statusDiv.innerHTML = `<span class="error">âŒ ì—°ê²° ì˜¤ë¥˜: ${error.message}</span>`;
            }
        }
        
        async function testFirestorePermissions() {
            if (!currentUser) {
                log('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
                return;
            }
            
            log('=== Firestore ê¶Œí•œ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
            
            try {
                // ì½ê¸° ê¶Œí•œ í…ŒìŠ¤íŠ¸
                log('Firestore ì½ê¸° ê¶Œí•œ í…ŒìŠ¤íŠ¸...');
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                log('Firestore ì½ê¸° ê¶Œí•œ OK', 'success');
                
                // ì“°ê¸° ê¶Œí•œ í…ŒìŠ¤íŠ¸
                log('Firestore ì“°ê¸° ê¶Œí•œ í…ŒìŠ¤íŠ¸...');
                await db.collection('users').doc(currentUser.uid).set({
                    test: 'permission_test',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                log('Firestore ì“°ê¸° ê¶Œí•œ OK', 'success');
                
            } catch (error) {
                log(`Firestore ê¶Œí•œ ì˜¤ë¥˜: ${error.code} - ${error.message}`, 'error');
                if (error.code === 'permission-denied') {
                    log('ë³´ì•ˆ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”: https://console.firebase.google.com', 'error');
                }
            }
        }
        
        async function testStoragePermissions() {
            if (!currentUser) {
                log('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
                return;
            }
            
            log('=== Storage ê¶Œí•œ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
            
            try {
                // ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
                const testBlob = new Blob(['test content'], { type: 'text/plain' });
                const testPath = `test/${currentUser.uid}/test.txt`;
                
                log('Storage ì—…ë¡œë“œ ê¶Œí•œ í…ŒìŠ¤íŠ¸...');
                const storageRef = storage.ref(testPath);
                const uploadTask = await storageRef.put(testBlob);
                
                log('Storage ì—…ë¡œë“œ ê¶Œí•œ OK', 'success');
                
                // ë‹¤ìš´ë¡œë“œ URL í…ŒìŠ¤íŠ¸
                log('Storage ë‹¤ìš´ë¡œë“œ URL í…ŒìŠ¤íŠ¸...');
                const downloadURL = await uploadTask.ref.getDownloadURL();
                log(`Storage ë‹¤ìš´ë¡œë“œ URL OK: ${downloadURL}`, 'success');
                
            } catch (error) {
                log(`Storage ê¶Œí•œ ì˜¤ë¥˜: ${error.code} - ${error.message}`, 'error');
            }
        }
        
        async function testProfileSave() {
            if (!currentUser) {
                log('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'warning');
                return;
            }
            
            log('=== í”„ë¡œí•„ ì €ì¥ í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
            const statusDiv = document.getElementById('profile-save-status');
            statusDiv.innerHTML = '<span class="info">í”„ë¡œí•„ ì €ì¥ ì¤‘...</span>';
            
            try {
                const nickname = document.getElementById('debug-nickname').value;
                const gender = document.getElementById('debug-gender').value;
                const birthdate = document.getElementById('debug-birthdate').value;
                const bio = document.getElementById('debug-bio').value;
                const profilePicFile = document.getElementById('debug-profile-pic').files[0];
                
                log(`í¼ ë°ì´í„°: ë‹‰ë„¤ì„=${nickname}, ì„±ë³„=${gender}, ìƒë…„ì›”ì¼=${birthdate}`);
                
                // í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ (ìˆë‹¤ë©´)
                let profilePictureURL = '';
                if (profilePicFile) {
                    log('í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘...');
                    const filePath = `profile_pictures/${currentUser.uid}/${Date.now()}_${profilePicFile.name}`;
                    const storageRef = storage.ref(filePath);
                    const uploadTask = await storageRef.put(profilePicFile);
                    profilePictureURL = await uploadTask.ref.getDownloadURL();
                    log(`í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì™„ë£Œ: ${profilePictureURL}`, 'success');
                }
                
                // Firestoreì— ì €ì¥
                log('Firestoreì— í”„ë¡œí•„ ë°ì´í„° ì €ì¥ ì¤‘...');
                const userProfile = {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    nickname: nickname,
                    gender: gender,
                    birthdate: birthdate,
                    bio: bio,
                    profilePictureURL: profilePictureURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid).set(userProfile, { merge: true });
                
                log('í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ!', 'success');
                statusDiv.innerHTML = '<span class="success">âœ… í”„ë¡œí•„ ì €ì¥ ì„±ê³µ!</span>';
                
                // ì €ì¥ëœ ë°ì´í„° í™•ì¸
                log('ì €ì¥ëœ ë°ì´í„° í™•ì¸ ì¤‘...');
                const savedDoc = await db.collection('users').doc(currentUser.uid).get();
                if (savedDoc.exists) {
                    log('ì €ì¥ëœ ë°ì´í„°: ' + JSON.stringify(savedDoc.data(), null, 2), 'info');
                }
                
            } catch (error) {
                log(`í”„ë¡œí•„ ì €ì¥ ì˜¤ë¥˜: ${error.message}`, 'error');
                log(`ì˜¤ë¥˜ ìŠ¤íƒ: ${error.stack}`, 'error');
                statusDiv.innerHTML = `<span class="error">âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
