<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œí•„ ìˆ˜ì • - ìº í¼ìŠ¤ ë§¤ì¹­</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .edit-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .edit-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .current-image {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .current-image img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #ff6b6b;
        }
        
        .current-image .placeholder {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: #f8f9fa;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #6c757d;
            border: 3px solid #ff6b6b;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .btn-save {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            flex: 2;
            transition: transform 0.2s;
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
        }
        
        .btn-save:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            flex: 1;
            transition: transform 0.2s;
        }
        
        .btn-cancel:hover {
            transform: translateY(-2px);
            background: #5a6268;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="edit-container">
            <div class="edit-header">
                <h1>í”„ë¡œí•„ ìˆ˜ì •</h1>
            </div>
            
            <div class="current-image">
                <div id="current-profile-image" class="placeholder">ğŸ‘¤</div>
                <p style="margin-top: 10px; color: #666; font-size: 14px;">í˜„ì¬ í”„ë¡œí•„ ì‚¬ì§„</p>
            </div>
            
            <form id="profile-edit-form">
                <div class="form-group">
                    <label for="profile-pic">ìƒˆ í”„ë¡œí•„ ì‚¬ì§„</label>
                    <input type="file" id="profile-pic" name="profile-pic" accept="image/*">
                    <small style="color: #666; font-size: 12px;">ìƒˆ ì‚¬ì§„ì„ ì„ íƒí•˜ì§€ ì•Šìœ¼ë©´ ê¸°ì¡´ ì‚¬ì§„ì´ ìœ ì§€ë©ë‹ˆë‹¤.</small>
                </div>
                
                <div class="form-group">
                    <label for="nickname">ë‹‰ë„¤ì„ *</label>
                    <input type="text" id="nickname" name="nickname" required>
                </div>
                
                <div class="form-group">
                    <label for="gender">ì„±ë³„ *</label>
                    <select id="gender" name="gender" required>
                        <option value="">ì„ íƒí•˜ì„¸ìš”...</option>
                        <option value="male">ë‚¨ì„±</option>
                        <option value="female">ì—¬ì„±</option>
                        <option value="other">ê¸°íƒ€</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="birthdate">ìƒë…„ì›”ì¼ *</label>
                    <input type="date" id="birthdate" name="birthdate" required>
                </div>
                
                <div class="form-group">
                    <label for="bio">ìê¸°ì†Œê°œ</label>
                    <textarea id="bio" name="bio" rows="4" placeholder="ê°„ë‹¨í•œ ìê¸°ì†Œê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-save">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
                    <button type="button" onclick="cancelEdit()" class="btn-cancel">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <p>í”„ë¡œí•„ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <script src="js/firebase-config.js"></script>
    
    <script>
        let auth, db, storage;
        let currentUser = null;
        let currentProfileData = null;

        document.addEventListener('DOMContentLoaded', () => {
            console.log("í”„ë¡œí•„ ìˆ˜ì • í˜ì´ì§€ ë¡œë“œ");
            
            try {
                // Firebase ì„œë¹„ìŠ¤ ì´ˆê¸°í™”
                auth = firebase.auth();
                db = firebase.firestore();
                storage = firebase.storage();
                
                // ì¸ì¦ ìƒíƒœ ë¦¬ìŠ¤ë„ˆ
                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUser = user;
                        console.log("ì‚¬ìš©ì ì¸ì¦ë¨:", user.email);
                        loadCurrentProfile();
                    } else {
                        console.log("ì‚¬ìš©ì ì¸ì¦ë˜ì§€ ì•ŠìŒ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™");
                        window.location.href = 'index.html';
                    }
                });
                
                // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                document.getElementById('profile-edit-form').addEventListener('submit', handleFormSubmit);
                
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                alert('ì´ˆê¸°í™” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // í˜„ì¬ í”„ë¡œí•„ ë¡œë“œ
        async function loadCurrentProfile() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    currentProfileData = userDoc.data();
                    console.log("í˜„ì¬ í”„ë¡œí•„ ë°ì´í„°:", currentProfileData);
                    fillForm(currentProfileData);
                } else {
                    console.log("í”„ë¡œí•„ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ");
                    alert("í”„ë¡œí•„ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í”„ë¡œí•„ì„ ë¨¼ì € ìƒì„±í•´ì£¼ì„¸ìš”.");
                    window.location.href = 'profile.html';
                }
                
            } catch (error) {
                console.error("í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:", error);
                alert('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // í¼ì— ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
        function fillForm(profileData) {
            document.getElementById('nickname').value = profileData.nickname || '';
            document.getElementById('gender').value = profileData.gender || '';
            document.getElementById('birthdate').value = profileData.birthdate || '';
            document.getElementById('bio').value = profileData.bio || '';
            
            // í˜„ì¬ í”„ë¡œí•„ ì‚¬ì§„ í‘œì‹œ
            if (profileData.profilePictureURL) {
                document.getElementById('current-profile-image').innerHTML = 
                    `<img src="${profileData.profilePictureURL}" alt="í˜„ì¬ í”„ë¡œí•„ ì‚¬ì§„">`;
            }
        }

        // í¼ ì œì¶œ ì²˜ë¦¬
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            console.log("í”„ë¡œí•„ ìˆ˜ì • ì œì¶œ");
            
            // ë¡œë”© í‘œì‹œ
            showLoading();
            
            try {
                // í¼ ë°ì´í„° ìˆ˜ì§‘
                const formData = {
                    nickname: document.getElementById('nickname').value.trim(),
                    gender: document.getElementById('gender').value,
                    birthdate: document.getElementById('birthdate').value,
                    bio: document.getElementById('bio').value.trim(),
                    profilePicFile: document.getElementById('profile-pic').files[0]
                };
                
                // ìœ íš¨ì„± ê²€ì‚¬
                if (!validateFormData(formData)) {
                    hideLoading();
                    return;
                }
                
                // ìƒˆ í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ (ì„ íƒëœ ê²½ìš°)
                let profilePictureURL = currentProfileData.profilePictureURL || '';
                if (formData.profilePicFile) {
                    console.log("ìƒˆ í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì‹œì‘");
                    profilePictureURL = await uploadProfilePicture(formData.profilePicFile);
                    console.log("ìƒˆ í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì™„ë£Œ:", profilePictureURL);
                }
                
                // Firestore ì—…ë°ì´íŠ¸
                const updatedProfile = {
                    nickname: formData.nickname,
                    gender: formData.gender,
                    birthdate: formData.birthdate,
                    bio: formData.bio,
                    profilePictureURL: profilePictureURL,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('users').doc(currentUser.uid).update(updatedProfile);
                
                console.log("í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì™„ë£Œ");
                hideLoading();
                
                alert("í”„ë¡œí•„ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
                window.location.href = 'my-profile.html';
                
            } catch (error) {
                console.error("í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
                hideLoading();
                alert(`í”„ë¡œí•„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        // ìœ íš¨ì„± ê²€ì‚¬
        function validateFormData(formData) {
            if (!formData.nickname) {
                alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return false;
            }
            
            if (!formData.gender) {
                alert("ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return false;
            }
            
            if (!formData.birthdate) {
                alert("ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return false;
            }
            
            // ë‚˜ì´ ê²€ì‚¬
            const birthDate = new Date(formData.birthdate);
            const today = new Date();
            const age = today.getFullYear() - birthDate.getFullYear();
            
            if (age < 18 || age > 100) {
                alert("ë‚˜ì´ëŠ” 18ì„¸ ì´ìƒ 100ì„¸ ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                return false;
            }
            
            return true;
        }

        // í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ
        async function uploadProfilePicture(file) {
            try {
                // íŒŒì¼ í¬ê¸° ê²€ì‚¬ (5MB ì œí•œ)
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    throw new Error("í”„ë¡œí•„ ì‚¬ì§„ì€ 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.");
                }
                
                // íŒŒì¼ í˜•ì‹ ê²€ì‚¬
                if (!file.type.startsWith('image/')) {
                    throw new Error("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                }
                
                // Storage ê²½ë¡œ ìƒì„±
                const filePath = `profile_pictures/${currentUser.uid}/${Date.now()}_${file.name}`;
                const storageRef = storage.ref(filePath);
                
                // íŒŒì¼ ì—…ë¡œë“œ
                const uploadTask = await storageRef.put(file);
                
                // ë‹¤ìš´ë¡œë“œ URL íšë“
                const downloadURL = await uploadTask.ref.getDownloadURL();
                
                return downloadURL;
                
            } catch (error) {
                console.error("í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
                throw error;
            }
        }

        // ìˆ˜ì • ì·¨ì†Œ
        function cancelEdit() {
            if (confirm("ë³€ê²½ì‚¬í•­ì´ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì •ë§ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                window.location.href = 'my-profile.html';
            }
        }

        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    </script>
</body>
</html>
